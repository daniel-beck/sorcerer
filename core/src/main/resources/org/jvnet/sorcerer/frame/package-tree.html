<!DOCTYPE html public "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <link rel="stylesheet" type="text/css" href="left-pane.css">
  <link rel="stylesheet" type="text/css" href="resource-files/tree/folder.css">
  <script type="text/javascript" src="resource-files/yahoo.js" ></script>
  <script type="text/javascript" src="resource-files/tree/treeview.js" ></script>
  <script type="text/javascript" src="left-pane.js" ></script>
  <script type="text/javascript" src="../sorcerer.js" ></script>
</head>
<body onload="start()">
<div id="treeDiv" style="white-space:nowrap;"></div>

<script type="text/javascript">
  var treeDiv = document.getElementById("treeDiv");
  var tree;
  var packageList;

  function setPackageList(o) {
    packageList = o;


    // augument the model objects by adding inferable properties to it
    function build(model,prefix) {
      model.fullName = (prefix+model.name).substring(1);

      // true if this is intermediate node and thus collapsed even for hierarchical view
      if(!model.hasClasses && model.children.length==1)
        model.intermediate = model.children[0]; // point to the sole child

      if(model.children!=null)
        for( var i=0; i<model.children.length; i++ )
          build(model.children[i], prefix+model.name+".");
    }
    build(packageList,"");
  }

  var loader = derive(scriptLoadManager,{
    // entry point to the load method
    loadClassList: function(model,treeNode,callback) {
      this.load(model.fullName, function(list) {
        addClassList(list,treeNode,callback);
      })
    },

    // load class-list.js by using the package name as the key
    getScriptName : function(packageName) {
      // path to class-list.js
      return packageName=="" ? "./class-list.js" : packageName.replace(/\./g,"/")+"/class-list.js";
    },

    postProcess : function(packageName,classList) {
      for( var j=0; j<classList.length; j++ ) {
        var c = classList[j];
        c.label = "<img src='resource-files/"+c.kind+"_"+c.access+".gif'> "+c.name;
        c.href = "source-view.html?"+c.script;
      }
    }
  });

  // display packages in a nested tree view
  var hierarchicalView = {
    icon: "resource-files/layout-hierarchical.gif",
    tooltip: "Hierarchical view",

    loadPackage : function() {
      // adds the child packages and classes to the given treeNode asynchronously,
      // and when ready, call back.
      function addChildPackagesTo(treeNode,model,callback) {
        // first add child packages
        if(model.children!=null) {
          for( var i=0; i<model.children.length; i++ ) {
            var cmodel = model.children[i];

            // skip any intermediate nodes
            var prefix="";
            while(cmodel.intermediate!=null) {
              prefix += cmodel.name+".";
              cmodel = cmodel.intermediate;
            }
            var o = {};
            o.label = prefix+cmodel.name;
            o.model = cmodel;
            var n = new YAHOO.widget.TextNode(o,treeNode,false);
            n.setDynamicLoad(function(node,onCompleteCallback) {
              addChildPackagesTo(node, node.data.model, onCompleteCallback);
            });
          }
        }

        // then load class list, if any
        if(model.hasClasses) {
          loader.loadClassList(model,treeNode,callback);
        } else {
          // if no class is in there, we are done
          callback();
        }
      }

      addChildPackagesTo(tree.getRoot(),packageList,function(){tree.draw();});
    },

    setClassList : function(packageName,classList) {
    }
  };

  // display packages in a flat view
  var flatView = {
    icon: "resource-files/layout-flat.gif",
    tooltip: "Flat view",

    loadPackage : function() {
      var root = tree.getRoot();

      // recursively add model nodes as flat pacakge list
      function buildTree(model) {
        if(model.hasClasses) {
          var o = {};
          o.model = model;
          if(model.fullName=="")
            o.label="(unnamed package)";
          else
            o.label=model.fullName;

          var n = new YAHOO.widget.TextNode(o,root,false);
          n.setDynamicLoad(function(node,callback) {
            loader.loadClassList(node.data.model, node, callback);
          });
        }
        if(model.children!=null)
          for( var i=0; i<model.children.length; i++ )
            buildTree(model.children[i]);
      }

      buildTree(packageList);

      tree.draw();
    }
  };

  // currently selected view mode
  var currentView = flatView;

  // called when class-list.js is loaded
  function setClassList(packageName,classList) {
    loader.loadComplete(packageName,classList);
  }

  // TODO: shouldn't this be merged into loader?
  function addClassList(classList, node, onComplete) {
    for( var j=0; j<classList.length; j++ ) {
      var c = classList[j];
      var cnode = new YAHOO.widget.TextNode(c, node, false);
      cnode.onLabelClick = function(me) {
        try {
          top.main.load(me.data.script);
        } catch(e) {/*don't let the navigation failure leak (which causes the page to be loaded on this frame.*/}
        return false;
      }
      // href is the only way to get link. you have to put javascript fragment in there
    }
    onComplete();
  }

  function errorCheck() {
    if(packageList==null) {
      // by now JSON should have been loaded,
      // but check anyway
      treeDiv.innerHTML = "<div class='error'>failed to load package list</div>";
      return true;
    }
    return false;
  }

  function start() {
    if(errorCheck())
      return;

    flatView.nextView = hierarchicalView;
    hierarchicalView.nextView = flatView; // couldn't figure out how to set this up with literal syntax

    tree = new YAHOO.widget.TreeView(treeDiv);
    currentView.loadPackage();
  }

  function toggleView(img) {
    pendingLoads = {}; // reset the pending activities

    img.src = currentView.icon;
    currentView = currentView.nextView;

    // create a new tree
    treeDiv.innerHTML="";
    tree = new YAHOO.widget.TreeView(treeDiv);
    currentView.loadPackage();
  }
</script>

<!-- load package list -->
<script type="text/javascript" src="package-list.js" ></script>
  </body>
</html>

