<!DOCTYPE html public "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <link rel="stylesheet" type="text/css" href="left-pane.css">
  <link rel="stylesheet" type="text/css" href="resource-files/tree/noicon.css">
  <script type="text/javascript" src="resource-files/yahoo.js" ></script>
  <script type="text/javascript" src="resource-files/tree/treeview.js" ></script>
  <script type="text/javascript" src="left-pane.js" ></script>
</head>
<body>
<div id="treeDiv" style="white-space:nowrap;"></div>
<script type="text/javascript">
  // tree for displaying "find usage" search result
  var treeDiv = document.getElementById("treeDiv");
  var tree = new YAHOO.widget.TreeView(treeDiv);

  var loader = {
    completedLoads : {},
    pendingLoads : {},

    /*
      load the usage for the given class name and anchor,
      and when ready invoke the callback with the loaded model
    */
    load : function(className,callback) {
      var model = this.completedLoads[className];
      if(model!=null) {
        callback(model);
      } else {
        var inject=false;
        var p = this.pendingLoads[className];
        if(p==null) {
          p = [];
          inject = true;
          this.pendingLoads[className] = p;
        }
        p.push(callback);
        if(inject) {
          loadScript(className.replace(/\./g,"/")+"-usage.js");
        }
      }
    },

    loadComplete : function(className,model) {
      // post process model
      function buildChildren(model,pkgPrefix) {
        for( var i=0; i<model.children.length; i++ )
          postProcess( model.children[i], pkgPrefix );
      }
      function postProcess(model,pkgPrefix) {
        model.name = pkgPrefix+model.name;
        if(model.kind=="package" && model.children!=null)
          buildChildren(model,model.name+".");
      }
      for( var x in model )
        buildChildren(model[x],"");


      this.completedLoads[className] = model;

      var p = this.pendingLoads[className];
      this.pendingLoads[className]=null;

      if(p!=null) {// this should be always true, but just to be defensive
        for( var i=0; i<p.length; i++ )
          p[i](model);
      }
    }
  }

  // called when *-usage.js is loaded
  function setClassUsage(className,model) {
    loader.loadComplete(className,model);
  }

  var current = null; // currently displayed

  function loadUsage(className,anchor) {
    current = { className:className, anchor:anchor };
    redraw();
  }

  // redraw the tree by using the current strategy, and the search target
  function redraw() {
    loader.load(current.className,function(model) {
      model = model[current.anchor];

      resetTree();
      if(model==null) {// not found
        var node = new YAHOO.widget.TextNode({label:"No usage found"}, tree.getRoot(), true);
        return;
      } else {
        addChildren(model.children, tree.getRoot(), true);
      }
      tree.draw();
    });
  }

  function resetTree() {
    treeDiv.innerHTML=""; // reset
    tree = new YAHOO.widget.TreeView(treeDiv);
  }

  function addChildren( children, node, expanded ) {
    if(children==null)  return;
    for( var i=0; i<children.length; i++ ) {
      insertNode( node, children[i], expanded );
    }
  }

  // insert a tree node from a model node
  function insertNode( parent, m, expanded ) {
    if(window.parent.toolbar.strategy(m)) {
      m.label = "<img src='resource-files/"+m.kind+(m.access!=null?"_"+m.access:"")+".gif'> "+m.name;
      m.target = "main";
      // model.href = '#'+model.line; // TODO

      var node = new YAHOO.widget.TextNode(m, parent, expanded);
      node.onLabelClick = function(me) {
        top.main.location.hash = '#'+me.data.line;
        return false;
      }
      parent = node;
    }
    addChildren( m.children, m.kind=="package"?tree.getRoot():parent, false );
    addChildren( m.classes, parent, false );
  }

</script>
</body>
</html>

