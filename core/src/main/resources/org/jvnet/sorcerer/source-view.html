<!DOCTYPE html public "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <!-- control visual presentation of the generated HTML -->
  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- stock JavaScript from YUI -->
  <script type="text/javascript" src="resource-files/yahoo.js" ></script>
  <link type='text/css' rel='stylesheet' href='menu/menu.css' />
  <script type='text/javascript' src='resource-files/yahoo.js'></script>
  <script type='text/javascript' src='resource-files/dom.js'></script>
  <script type='text/javascript' src='resource-files/event.js'></script>
  <script type='text/javascript' src='resource-files/container.js'></script>
  <script type='text/javascript' src='menu/menu.js'></script>

  <script type="text/javascript" src="sorcerer.js" ></script>
  <script type="text/javascript" src="left-pane.js" ></script>
<!-- computes link target -->
<script type="text/javascript">
  var linker = {
    // computes a link to a type.
    //   t: type table entry
    type : function(t) { return null; },
    // computes a link to a method.
    //   m: method table entry
    method: function(m) { return null; },
    // computes a link to a field
    //   t: type table entry
    //   name: field name
    field: function(t,name) { return null; }
  };

  // generates links to external javadoc
  var javadocLinker = derive(linker, {
    baseURL: null, // the base URL of the javadoc
    type : function(t) {
      return this.baseURL+t.fullName.replace(/\./g,"/")+".html";
    },
    method : function(m) {
      // TODO: javadoc doesn't really use erasure format. Doh!
      return this.type(m.owner)+'#'+m.signature();
    },
    field : function(t,name) {
      return this.type(t)+'#'+name;
    }
  });

</script>
<!-- HTML generator -->
<script type="text/javascript">

String.prototype.startsWith = function(rhs) {
  var len = rhs.length;
  if(this.length<len)  return false;
  return this.substr(0,len)==rhs;
}

// take a base factory implementation and make it 'full' by deriving additional properties and functions.
function makeFull(f) {
  f = object(f);

  f.a  = f.reservedWord('abstract');
  f.as = f.reservedWord('assert');
  f.b  = f.primitiveType('boolean');
  f.br = f.reservedWord('break');
  f.by = f.primitiveType('byte');
  f.ca = f.reservedWord('case');
  f.ct = f.reservedWord('catch');
  f.ch = f.primitiveType('char');
  f.c  = f.reservedWord('class');
  f.cs = f.reservedWord('const');
  f.co = f.reservedWord('continue');
  f.de = f.reservedWord('default');
  f.d  = f.reservedWord('do');
  f.db = f.primitiveType('double');
  f.e  = f.reservedWord('else');
  f.en = f.reservedWord('enum');
  f.ex = f.reservedWord('extends');
  f.f  = f.reservedWord('final');
  f.fn = f.reservedWord('finally');
  f.fl = f.primitiveType('float');
  f.fo = f.reservedWord('for');
  f.i  = f.reservedWord('if');
  f.im = f.reservedWord('implements');
  f.ip = f.reservedWord('import');
  f.is = f.reservedWord('instanceof');
  f.j  = f.primitiveType('int');
  f.it = f.reservedWord('interface');
  f.l  = f.primitiveType('long');
  f.na = f.reservedWord('native');
  f.n  = f.reservedWord('new');
  f.pa = f.reservedWord('package');
  f.pi = f.reservedWord('private');
  f.po = f.reservedWord('protected');
  f.pu = f.reservedWord('public');
  f.r  = f.reservedWord('return');
  f.sh = f.primitiveType('short');
  f.s  = f.reservedWord('static');
  f.sf = f.reservedWord('strictfp');
  f.su = f.reservedWord('super');
  f.sw = f.reservedWord('switch');
  f.sy = f.reservedWord('synchronized');
  f.t  = f.reservedWord('this');
  f.tw = f.reservedWord('throw');
  f.ts = f.reservedWord('throws');
  f.tt = f.reservedWord('transient');
  f.tr = f.reservedWord('try');
  f.v  = f.primitiveType('void');
  f.vl = f.reservedWord('volatile');
  f.wh = f.reservedWord('while');
  f._  = f.w(1);

  f.conv = function(a) {
    if(typeof a=='string')
      a=f.sourceText(a);
    return a;
  };

  f.$ = function(/*...*/) {
    // convert one instance

    var len=arguments.length;
    if(len==1)  return f.conv(arguments[0]);

    return f.$$(arguments);
  };

  f.$$ = function(array) {
    // pack multiple items into a container
    var len=array.length;
    for( var i=len-1; i>=0; i-- )
      array[i] = f.conv(array[i]);
    return f.group(array);
  };

  return f;
}

var makeWhitespace = function() {
  var s="";
  var wsTable = [];
  for(var i=0; i<8; i++ ) {
    wsTable[i]=s;
    s += ' ';
  }
  return function(n) {
    if(n<8)   return wsTable[n];

    var s="";
    while(n>=8) {
      s+="        ";
      n-=8;
    }
    return s+wsTable[n];
  }
}();

var tableEntry = {
  kind: null,   // tag that identifies the kind of table
  css:  null,   // CSS classes to be used for referencing this method
  href : null,  // link to the definition of this method
  usage : function(){},  // computes the "find usage" index key.
  displayText : function() {} // computes the text to be displayed
};

var typeTableEntry = derive(tableEntry,{
  kind: "type",
  fullName: null,   // FQCN
  shortName: null,  // name within the package
  linker: null,     // hyperlinks to this type shall be generated using this linker
  usage : function() {
    return this.fullName+"#this";
  },
  displayText : function() {
    return this.shortName; // TODO: this is incorrect --- we just show the short name even for nested classes.
  }
});

// one entry of the method table
var methodTableEntry = derive(tableEntry,{
  kind: "method",
  usage : function() {
    return this.owner.fullName+"#"+this.signature();
  },
  displayText : function() {
    return this.name;
  },

  owner: null, // reference to owner type
  name : null, // short method name
  params : [], // array of strings that represent erased parameter type names in FQCN

  // compute the method signature of the form "methodName(param1,param2,...)"
  signature : function() {
    var s = this.name+'(';
    for(var i=0; i<this.params.length; i++) {
      if(i!=0) s+=',';
      s+=this.params[i];
    }
    s+=')';
    return s;
  }
});


builder = makeFull({

  reservedWord : function(name) {
    return function(context) {
      context.css('rw').appendText(name).pop();
    }
  },
  primitiveType : function(name) {
    return function(context) {
      context.css('pr').appendText(name).pop();
    }
  },
  group : function(children) {
    return function(context) {
      for(var i=0;i<children.length;i++)
        children[i](context);
    }
  },
  sourceText : function(text) {
    return function(context) {
      context.appendText(text);
    }
  },

  // comment
  O : function(/*...*/) {
    // determine CSS class
    var head = arguments[0];
    var style;
    if(head.startsWith("//"))
      style = "cs";
    else
    if(head.startsWith("/**"))
      style = "cj";
    else
      style = "cm";

    var children = this.$$(arguments);

    return function(context) {
      context.css(style);
      children(context);
      context.pop();
    }
  },

  // whitespace
  w : function(n) {
    return function(context) {
      context.appendText(makeWhitespace(n));
    }
  },

  nl : function(context) {
    context.appendText('\n');
    context.lineNumber++;
  },

  C : function(typeTableIndex,descendants,children) { // class
    // TODO: handle descendants
    return function(context) {
      var old = context.currentDecl;
      context.currentDecl = context.me.types[typeTableIndex];
      children(context);
      context.currentDecl = old;
    }
  },

  I : function(text) { // identifier in method/class declaration
    return function(context) {
      var d = context.currentDecl;
      context.link(d.href).css(d.css+" d",d.usage())
          .appendText(d.displayText()).pop().pop();
    }
  },

  B : function(/*...*/) { // curly brackets {...}
    return this.parenthesis('{','}',this.$$(arguments));
  },

  P : function(/*...*/) { // parenthesis (...)
    return this.parenthesis('(',')',this.$$(arguments));
  },

  parenthesis : function(L,R,children) {
    return function(context) { // TODO: scroll to the other bracket by clicking
      var span = document.createElement("span");
      context.push(span);

      var open = document.createElement("span");
      context.push(open);
      context.appendText(L);
      context.pop();

      children(context);

      var closed = document.createElement("span");
      context.push(closed);
      context.appendText(R);
      context.pop();

      context.pop();

      var highlighter = function(lhs,rhs) {
        lhs.onmouseover = function() {
          lhs.className="highlighted-bracket";
          rhs.className="highlighted-bracket";
        }
        lhs.onmouseout = function() {
          lhs.className="";
          rhs.className="";
        }
      };
      highlighter(open,closed);
      highlighter(closed,open);
    }
  },

  M : function(methodTableIndex,sup,sub,children) { // method declaration
    // TODO: handle annotation
    return function(context) {
      var old = context.currentDecl;
      context.currentDecl = context.me.methods[methodTableIndex];
      children(context);
      context.currentDecl = old;
    }
  },

  N : function(n) { // method reference
    return function(context) {
      var m = context.me.methods[n];
      context.link(m.href).css(m.css+" r",m.usage()).appendText(m.name).pop().pop();
    }
  },


  T : function(n) { // type reference
    return function(context) {
      var t = context.me.types[n];
      context.link(t.href).css(t.css+" r",t.usage()).appendText(t.shortName).pop().pop();
    }
  },

  V : function(/*arguments*/) {// TODO: mark up and annotation
    return this.$$(arguments);
  },

  F : function(typeIdx,mods,name) {// field reference
    return function(context) {
      var t = context.me.types[typeIdx];
      context.link(t.linker.field(t,name)).css(mods+" r",t.fullName+'#'+name).appendText(name).pop().pop();
    }
  },

  L : function(str) { // literal
    return function(context) {
      context.css("lt").appendText(str).pop();
    }
  },


  typeTable: function(table) {
    for(var i=0;i<table.length;i++) {
      var t = object(typeTableEntry);

      t.fullName = table[i][0];
      t.css = table[i][1];

      // this is not a correct way to compute the short name, for nested classes
      idx=t.fullName.lastIndexOf('.');
      t.shortName=t.fullName.substring(idx+1);

      // TODO: testing. need to be configurable
      t.linker = derive(javadocLinker,{baseURL:"http://java.sun.com/j2se/1.5.0/docs/api/"});
      t.href = t.linker.type(t);

      table[i] = t;
    }
    // assign this to the table
    this.types = table;
  },
  methodTable: function(table) {
    for(var i=0;i<table.length;i++) {
      var e = table[i];
      var m = object(methodTableEntry);
      m.owner = this.types[e[0]];
      m.name = e[1];
      m.params = e[2];
      for(var j=0;j<m.params.length;j++) {
        if(typeof m.params[j] == "number")
          m.params[j] = this.types[m.params[j]].fullName;
      }

      m.css = e[3]+" r";
      m.href = m.owner.linker.method(m);

      table[i] = m;
    }
    this.methods = table;
  },

  classDef : function(/*...*/) {
    return this.$$(arguments);
  }
});



function load(name) {
  loadScript(name);
}

function defineStructure(className,tree) {
  // use a copy of builder (this will receive symbol tables)
  var b=object(builder);
  var sourceBuilder = tree(b);
  var pre = document.getElementById("main");

  // the context object to be passed around the dom builder functions
  var context = {
    node : pre,         // current node
    me : b,             // to access the builder
    currentDecl : null, // when we are building inside a method/class declaration,
                        // this field points to that declaration
    lineNumber : 1,     // current line
    appendText : function(text) {
      this.node.appendChild(document.createTextNode(text));
      return this;
    },
    push : function(e) {
      this.node.appendChild(e);
      this.node = e;
      return e;
    },
    pop : function() {
      this.node = this.node.parentNode;
      return this;
    },
    // wrap by a CSS class
    //   usageKey : optional. usage search key like "java.lang.String#indexOf()"
    css : function(style,usageKey) {
      e = document.createElement("span");
      e.setAttribute("class",style);
      this.push(e);
      if(usageKey!=null) {
        e.parentNode.setAttribute("u",usageKey);
        prepareMenu(e);
      }
      return this;
    },
    // wrap by anchor link
    link : function(href) {
      e = document.createElement("a");
      if(href!=null)
        e.setAttribute("href",href);
      this.push(e);
      return this;
    }
  };
  // build the main source code HTML
  sourceBuilder(context);

  // build the line number table
  function pad(s,n) {
    while(s.length<n)
      s=' '+s;
    return s;
  }

  var lnt = document.getElementById("lineNumberTable");
  for(var i=1;i<=context.lineNumber;i++) {
    var a = document.createElement("a");
    a.setAttribute("name",i);
    a.setAttribute("href",'#'+String(i));
    a.appendChild(document.createTextNode(pad(String(i),4)+'\n'));
    lnt.appendChild(a);
  }
}
</script>
<!-- menu handling -->
<script type="text/javascript">
// controls time out action and cancellation
function Future(action,timeout) {
  this.schedule=function() {
    if(this.token!=null)
      window.clearTimeout(this.token);
    this.token=window.setTimeout(function() {
      this.token=null;
      action();
    },timeout);
  }
  this.cancel=function() {
    if(this.token!=null)
      window.clearTimeout(this.token);
    this.token=null;
  }
}



var menu;
var menuSelector;
var menuSelectorCanceller;

/*
  prepare context menu hook up for the given span element.
*/
function prepareMenu(span) {
  span.onmouseover=function() {
    var xy = YAHOO.util.Dom.getXY(this);
    xy[0] += this.offsetWidth;
    YAHOO.util.Dom.setXY(menuSelector,xy);
    menuSelector.style.visibility = "visible";
    menuSelector.target=this;
  }
  span.onmouseout=function() {
    menuSelectorCanceller.schedule();
  }
}

window.onload = function() {
  // Create the menu
  menu = new YAHOO.widget.Menu("contextmenu");
  menuSelector = document.getElementById('menuSelector');

  var menuItems = [
      {
        text: "dummy", // determined dynamically
        action: function() {
          window.location=menu.target.parentNode.href;
        },
        preshow: function(type,args,menuItem) {
          if(YAHOO.util.Dom.hasClass(menu.target,"d"))
            menuItem.cfg.setProperty("text", "Permalink");
          else
            menuItem.cfg.setProperty("text", "Go to declaration");
          menuItem.cfg.setProperty("url",menu.target.parentNode.href);
        }
      },
      {
        text: "Find usages",
        action: function() {
          parent.searchpane.displayController.show(menu.target.parentNode);
        }
      }
    ];

  // Add items to the main menu
  for(var i=0; i<menuItems.length; i++) {
      menuItem =
          new YAHOO.widget.MenuItem(menuItems[i].text);
      menuItem.clickEvent.subscribe(menuItems[i].action);
      menu.addItem(menuItem);
      if(menuItems[i].preshow!=null)
        menu.beforeShowEvent.subscribe(menuItems[i].preshow,menuItem);
  }


  menu.render(document.body);


  // for hiding menu after a timeout
  var canceller = new Future(function() {
    menu.hide();
  },750);

  menu.mouseOverEvent.subscribe(function(){canceller.cancel();});
  menu.mouseOutEvent.subscribe(function(){canceller.schedule();});

  // show context menu for the program element
  //    target : b element that has information about the program element
  //             its parent is always <a> that has links.
  function showMenu(target) {
    menu.cfg.setProperty("context", [target, "tl", "tr"]);
    menu.target=target;
    menu.show();
    return false;
  }

  document.onclick=function(e) {
    if(YAHOO.util.Event.getTarget(e,false)!=menuSelector)
      menu.hide();
  }

  // menu selector control
  menuSelectorCanceller = new Future(function() {
    menuSelector.style.visibility = "hidden";
  },750);
  menuSelector.onmouseover=function() {
    menuSelectorCanceller.cancel();
  };
  menuSelector.onmouseout=function() {
    menuSelectorCanceller.schedule();
  };
  menuSelector.onclick=function() {
    showMenu(this.target);
    menuSelector.style.visibility="hidden";
  };

  // testing. load the source code
  var qs = window.location.search;
  if(qs!=null && qs.length>1) {
    // TODO: this is a security hole as it allows any script to be loaded.
    load(qs.substring(1));
  }

  //Behaviour.register({
  //  ".popup" : function(e) {
  //    e.parentNode.popup = e;
  //  },
  //
  //  ".bookmark" : function(e) {
  //    e.onmouseover = function() {
  //      this.popup.style.display="block";
  //    };
  //    e.onmouseout  = function() {
  //      this.popup.style.display="none";
  //    };
  //  }
  //});

}
</script>
</head>
<body>
<div style='position:relative;'>
  <!-- the '>' floating tip -->
  <div id="menuSelector"></div>
  <pre id=main style='padding-left:3em'></pre>
  <pre id=lineNumberTable style='position:absolute; left:0; top:0;'></pre>
</div>
</body>
</html>

