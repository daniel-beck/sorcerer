<!DOCTYPE html public "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <!-- control visual presentation of the generated HTML -->
  <link rel="stylesheet" type="text/css" href="style.css">

  <!-- stock JavaScript from YUI -->
  <link type='text/css' rel='stylesheet' href='menu/menu.css' />
  <script type='text/javascript' src='resource-files/yahoo.js'></script>
  <script type='text/javascript' src='resource-files/dom.js'></script>
  <script type='text/javascript' src='resource-files/event.js'></script>
  <script type='text/javascript' src='resource-files/container.js'></script>
  <script type='text/javascript' src='resource-files/logger.js'></script>
  <link type='text/css' rel='stylesheet' href='resource-files/logger.css' />
  <script type='text/javascript' src='menu/menu.js'></script>
<!-- HTML generator -->
<script type="text/javascript">
// import source view scripts
var sourceView = window.top.sourceView;
sourceView.document = document;
sourceView.window = window;


// invoked from AST JavaScript when loading is complete
</script>
<!-- menu handling -->
<script type="text/javascript">



var menu;
var menuSelector;
var menuSelectorCanceller;
var bookmarkMenu=null;
// all bookmarks on the page keyed by ID.
// bookmark onclick JavaScript uses this to find the correct bookmark object
var bookmarks = {};

/*
  prepare context menu hook up for the given span element.
*/
function prepareMenu(span) {
  span.onmouseover=function() {
    var xy = YAHOO.util.Dom.getXY(this);
    xy[0] += this.offsetWidth;
    YAHOO.util.Dom.setXY(menuSelector,xy);
    menuSelector.style.visibility = "visible";
    menuSelector.target=this;
  }
  span.onmouseout=function() {
    menuSelectorCanceller.schedule();
  }
}

window.onload = function() {
  try {
    // TODO: how to selectively enable debugging?
    // log reader for debugging
    new YAHOO.widget.LogReader();
  } catch(e) {
    // in the production environment 
  }

  // Create the menu
  menu = new YAHOO.widget.Menu("contextmenu");
  menuSelector = document.getElementById('menuSelector');

  var menuItems = [
      {
        text: "dummy", // determined dynamically
        action: function() {
          window.location=menu.target.parentNode.href;
        },
        preshow: function(type,args,menuItem) {
          if(YAHOO.util.Dom.hasClass(menu.target,"d"))
            menuItem.cfg.setProperty("text", "Permalink");
          else
            menuItem.cfg.setProperty("text", "Go to declaration");
          menuItem.cfg.setProperty("url",menu.target.parentNode.href);
        }
      },
      {
        text: "Find usages",
        action: function() {
          parent.searchpane.displayController.show(menu.target.parentNode);
        }
      }
    ];

  // Add items to the main menu
  for(var i=0; i<menuItems.length; i++) {
      menuItem =
          new YAHOO.widget.MenuItem(menuItems[i].text);
      menuItem.clickEvent.subscribe(menuItems[i].action);
      menu.addItem(menuItem);
      if(menuItems[i].preshow!=null)
        menu.beforeShowEvent.subscribe(menuItems[i].preshow,menuItem);
  }


  menu.render(document.body);


  // for hiding menu after a timeout
  var canceller = sourceView.makeFuture(function() {
    menu.hide();
  },750);

  menu.mouseOverEvent.subscribe(function(){canceller.cancel();});
  menu.mouseOutEvent.subscribe(function(){canceller.schedule();});

  // show context menu for the program element
  //    target : b element that has information about the program element
  //             its parent is always <a> that has links.
  function showMenu(target) {
    menu.cfg.setProperty("context", [target, "tl", "tr"]);
    menu.target=target;
    menu.show();
    return false;
  }

  document.onclick=function(e) {
    if(YAHOO.util.Event.getTarget(e,false)!=menuSelector)
      menu.hide();
    if(bookmarkMenu!=null)
      bookmarkMenu.hide();
  }

  // menu selector control
  menuSelectorCanceller = sourceView.makeFuture(function() {
    menuSelector.style.visibility = "hidden";
  },750);
  menuSelector.onmouseover=function() {
    menuSelectorCanceller.cancel();
  };
  menuSelector.onmouseout=function() {
    menuSelectorCanceller.schedule();
  };
  menuSelector.onclick=function() {
    showMenu(this.target);
    menuSelector.style.visibility="hidden";
  };

  // testing. load the source code
  var qs = window.location.search;
  if(qs!=null && qs.length>1) {
    // TODO: this is a security hole as it allows any script to be loaded.
    sourceView.load(qs.substring(1));
  }
}
</script>
</head>
<body>
<div style='position:relative;'>
  <!-- the '>' floating tip -->
  <div id="menuSelector"></div>
  <pre id=main style='padding-left:3em'></pre>
  <pre id=lineNumberTable style='position:absolute; left:0; top:0;'></pre>
</div>
</body>
</html>

